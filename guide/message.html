<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/koishi.png"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#5546a3"><title>接收和发送消息 | Koishi</title><meta name="description" content="">
    <link rel="modulepreload" href="/v3/assets/app.9e111ae1.js"><link rel="modulepreload" href="/v3/assets/message.html.cbdf8b5f.js"><link rel="modulepreload" href="/v3/assets/message.html.72d4fb15.js">
    <link rel="stylesheet" href="/v3/assets/style.50b5c507.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/v3/" class=""><!----><span class="site-name can-hide">Koishi</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/v3/" class="nav-link" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/guide/starter.html" class="nav-link" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/api/" class="nav-link" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/plugins/" class="nav-link" aria-label="官方插件"><!--[--><!--]--> 官方插件 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/koishijs/koishi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/v3/" class="nav-link" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/guide/starter.html" class="nav-link" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/api/" class="nav-link" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/v3/plugins/" class="nav-link" aria-label="官方插件"><!--[--><!--]--> 官方插件 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/koishijs/koishi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">入门</p><ul class=""><li><!--[--><a href="/v3/guide/about.html" class="nav-link sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/starter.html" class="nav-link sidebar-item" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/cli.html" class="nav-link sidebar-item" aria-label="命令行工具"><!--[--><!--]--> 命令行工具 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/docker.html" class="nav-link sidebar-item" aria-label="使用 Docker"><!--[--><!--]--> 使用 Docker <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/faq.html" class="nav-link sidebar-item" aria-label="常见问题"><!--[--><!--]--> 常见问题 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item active">交互</p><ul class=""><li><!--[--><a aria-current="page" href="/v3/guide/message.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="接收和发送消息"><!--[--><!--]--> 接收和发送消息 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/v3/guide/message.html#使用中间件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用中间件"><!--[--><!--]--> 使用中间件 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/v3/guide/message.html#注册和取消中间件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注册和取消中间件"><!--[--><!--]--> 注册和取消中间件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#注册异步中间件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注册异步中间件"><!--[--><!--]--> 注册异步中间件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#注册前置中间件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注册前置中间件"><!--[--><!--]--> 注册前置中间件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#注册临时中间件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注册临时中间件"><!--[--><!--]--> 注册临时中间件 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#使用会话" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用会话"><!--[--><!--]--> 使用会话 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/v3/guide/message.html#延时发送" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="延时发送"><!--[--><!--]--> 延时发送 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#等待用户输入" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="等待用户输入"><!--[--><!--]--> 等待用户输入 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#调用底层接口" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="调用底层接口"><!--[--><!--]--> 调用底层接口 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#发送广播消息" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="发送广播消息"><!--[--><!--]--> 发送广播消息 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#处理消息文本" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="处理消息文本"><!--[--><!--]--> 处理消息文本 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/v3/guide/message.html#使用消息段" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用消息段"><!--[--><!--]--> 使用消息段 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/v3/guide/message.html#使用模板" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用模板"><!--[--><!--]--> 使用模板 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/v3/guide/context.html" class="nav-link sidebar-item" aria-label="插件与上下文"><!--[--><!--]--> 插件与上下文 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">指令</p><ul class=""><li><!--[--><a href="/v3/guide/command.html" class="nav-link sidebar-item" aria-label="指令系统初探"><!--[--><!--]--> 指令系统初探 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/execute.html" class="nav-link sidebar-item" aria-label="指令的触发机制"><!--[--><!--]--> 指令的触发机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/help.html" class="nav-link sidebar-item" aria-label="查看和编写帮助"><!--[--><!--]--> 查看和编写帮助 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/decorator.html" class="nav-link sidebar-item" aria-label="使用装饰器 (beta)"><!--[--><!--]--> 使用装饰器 (beta) <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">数据库</p><ul class=""><li><!--[--><a href="/v3/guide/database.html" class="nav-link sidebar-item" aria-label="使用数据库"><!--[--><!--]--> 使用数据库 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/manage.html" class="nav-link sidebar-item" aria-label="用户系统管理"><!--[--><!--]--> 用户系统管理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/database-support.html" class="nav-link sidebar-item" aria-label="编写数据库支持"><!--[--><!--]--> 编写数据库支持 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">高级</p><ul class=""><li><!--[--><a href="/v3/guide/lifecycle.html" class="nav-link sidebar-item" aria-label="事件与生命周期"><!--[--><!--]--> 事件与生命周期 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/adapter.html" class="nav-link sidebar-item" aria-label="多账户与跨平台"><!--[--><!--]--> 多账户与跨平台 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/logger.html" class="nav-link sidebar-item" aria-label="输出与日志"><!--[--><!--]--> 输出与日志 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/v3/guide/unit-tests.html" class="nav-link sidebar-item" aria-label="单元测试"><!--[--><!--]--> 单元测试 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="接收和发送消息" tabindex="-1"><a class="header-anchor" href="#接收和发送消息" aria-hidden="true">#</a> 接收和发送消息</h1><p>从本节开始，我们开始深入研究如何利用 Koishi 的来接收和发送消息。</p><p>首先让我们回顾一下之前展示过的 <a href="/v3/guide/starter.html#%E7%BC%96%E5%86%99%E5%B9%B6%E8%B0%83%E7%94%A8%E4%BD%A0%E7%9A%84%E6%8F%92%E4%BB%B6" class="">基本实例</a>：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 如果收到“天王盖地虎”，就回应“宝塔镇河妖”</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.content </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;天王盖地虎&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;宝塔镇河妖&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>在这个简单的示例中，这里有两件事你需要了解：</p><p>上面的 <code>ctx.middleware()</code> 方法所传入的回调函数成为 <strong>中间件</strong>。你可以使用中间件来处理所有收到的一切消息。如果你希望处理其他类型的事件（例如加群申请又或者消息撤回等等），可以使用 Koishi 的 <a href="/v3/guide/lifecycle.html#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F" class="">事件系统</a>，这将在后面的章节中介绍。</p><p>上面的 <code>session</code> 对象被称为 <strong>会话</strong>。所有的上报事件都会被转化成一个会话对象。你可以利用这个对象访问与此事件有关的数据（例如用 <code>session.content</code> 表示消息的内容），或调用 API 作为对此事件的响应（例如用 <code>session.send()</code> 在当前频道内发送消息）。</p><h2 id="使用中间件" tabindex="-1"><a class="header-anchor" href="#使用中间件" aria-hidden="true">#</a> 使用中间件</h2><p>有了接收和发送消息的能力，似乎你就能完成一切工作了——很多机器人框架也的确是这么想的。但是从 Koishi 的角度，这还远远不够。当载入的功能越来越多后，另一些严重的问题将逐渐浮现出来：如何限制消息能触发的应答次数？如何进行权限管理？如何提高机器人的性能？这些问题的答案将我们引向另一套更高级的系统——这也就是 <strong>中间件</strong> 的由来。</p><p>中间件是对消息事件处理流程的再封装。你注册的所有中间件将会由一个事件监听器进行统一管理，数据流向下游，控制权流回上游——这可以有效确保了任意消息都只被处理一次。被认定为无需继续处理的消息不会进入下游的中间件——这让我们能够轻易地实现权限管理。与此同时，Koishi 的中间件也支持异步调用，这使得你可以在中间件函数中实现任何逻辑。事实上，相比更加底层地调用事件监听器，<strong>使用中间件处理消息才是 Koishi 更加推荐的做法</strong>。</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>在你阅读下面的内容之前，你首先应该了解中间件是为了 <strong>处理消息</strong> 而设计的。因此，如果你要处理的是加群申请之类的其他事件，那么你还是应该使用事件监听器来处理。</p></div><p>中间件的本质是下面的函数。看起来挺简单的，不是吗？我们将在下面详细介绍它的运作方式。</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">NextFunction</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F92672;">?:</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">NextFunction</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">any</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">Middleware</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">Session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">NextFunction</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">any</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><h3 id="注册和取消中间件" tabindex="-1"><a class="header-anchor" href="#注册和取消中间件" aria-hidden="true">#</a> 注册和取消中间件</h3><p>使用 <code>ctx.middleware()</code> 方法注册中间件。这个方法接受一个回调函数，其第一个参数为一个会话对象，第二个参数是 <code>next</code> 函数，只有调用了它才会进入接下来的流程。如果自始至终都没有调用 <code>next</code> 函数的话，之后的中间件都将不会被执行。下面是一个例子：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 仅当接收到的消息包含了对机器人的称呼时才继续处理（比如消息以 @机器人 开头）</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.parsed.appel) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;是你在叫我吗？&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 如果去掉这一行，那么不满足上述条件的消息就不会进入下一个中间件了</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>这个函数的返回值是一个新的函数，调用这个函数就可以完成取消上述中间件：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> dispose </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">(callback)</span></span>
<span class="line"><span style="color:#A6E22E;">dispose</span><span style="color:#F8F8F2;">() </span><span style="color:#88846F;">// 取消中间件</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><h3 id="注册异步中间件" tabindex="-1"><a class="header-anchor" href="#注册异步中间件" aria-hidden="true">#</a> 注册异步中间件</h3><p>中间件也可以是异步的。下面给出一个示例：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">async</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 获取数据库中的用户信息</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 这里只是示例，事实上 Koishi 会自动获取数据库中的信息并存放在 session.user 中</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> user </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">getUser</span><span style="color:#F8F8F2;">(session.userId)</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (user.authority </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;抱歉，你没有权限访问机器人。&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><div class="custom-container warning"><p class="custom-container-title">注意</p><p>异步中间件代码中 next 前面的 return 是必须的。如果删去将可能会导致时序错误，这在 Koishi 中将会抛出一个运行时警告。</p></div><h3 id="注册前置中间件" tabindex="-1"><a class="header-anchor" href="#注册前置中间件" aria-hidden="true">#</a> 注册前置中间件</h3><p>从上面的两个例子中不难看出，中间件是一种消息过滤的利器。但是反过来，当你需要的恰恰是捕获全部消息时，中间件反而不会是最佳选择——因为前置的中间件可能会将消息过滤掉，导致你注册的回调函数根本不被执行。因此在这种情况下，我们更推荐使用事件监听器。然而，还存在着这样一种情况：你既需要捕获全部的消息，又要对其中的一些加以回复，这又该怎么处理呢？</p><p>听起来这种需求有些奇怪，让我们举个具体点例子吧：假如你写的是一个复读插件，它需要在每次连续接收到 3 条相同消息时进行复读。我们不难使用事件监听器实现这种逻辑：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 复读次数</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 当前消息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">on</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;message&#39;</span><span style="color:#F8F8F2;">, (</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 这里其实有个小问题，因为来自不同群的消息都会触发这个回调函数</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 因此理想的做法应该是分别记录每个群的当前消息和复读次数</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 但这里我们假设机器人只处理一个群，这样可以简化逻辑</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.content </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> message) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">+=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (times </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">) session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(message)</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>
<span class="line"><span style="color:#F8F8F2;">    message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> session.content</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>但是这样写出的机器人就存在所有用事件监听器写出的机器人的通病——如果这条消息本身可以触发其他回应，机器人就会多次回应。更糟糕的是，你无法预测哪一次回应先发生，因此这样写出的机器人就会产生延迟复读的迷惑行为。为了避免这种情况发生，Koishi 对这种情况也有对应的解决方案，那就是 <strong>前置中间件</strong>：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 复读次数</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 当前消息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.content </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> message) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">+=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (times </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(message)</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>
<span class="line"><span style="color:#F8F8F2;">    message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> session.content</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}, </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">/* true 表示这是前置中间件 */</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><h3 id="注册临时中间件" tabindex="-1"><a class="header-anchor" href="#注册临时中间件" aria-hidden="true">#</a> 注册临时中间件</h3><p>有的时候，你也可能需要实现这样一种逻辑：你的中间件产生了一个响应，但你认为这个响应优先级较低，希望等后续中间件执行完毕后，如果信号仍然未被截取，就执行之前的响应。这当然可以通过注册新的中间件并取消的方法来实现，但是由于这个新注册的中间件可能不被执行，你需要手动处理许多的边界情况。</p><p>为了应对这种问题 Koishi 提供了更加方便的写法：你只需要在调用 <code>next</code> 时再次传入一个回调函数即可！这个回调函数只接受一个 <code>next</code> 参数，且只会加入当前的中间件执行队列；无论这个回调函数执行与否，在本次中间件解析完成后，它都会被清除。下面是一个例子：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.content </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;hlep&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 如果该 session 没有被截获，则这里的回调函数将会被执行</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;你想说的是 help 吗？&#39;</span><span style="color:#F8F8F2;">))</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>除此以外，临时中间件还有下面的用途。让我们先回到上面介绍的前置中间件。它虽然能够成功解决问题，但是如果有两个插件都注册了类似的前置中间件，就仍然可能发生一个前置中间件截获了消息，导致另一个前置中间件获取不到消息的情况发生。但是，借助临时中间件，我们便有了更好的解决方案：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 复读次数</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// 当前消息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.content </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> message) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">+=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (times </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(message))</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    times </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>
<span class="line"><span style="color:#F8F8F2;">    message </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> session.content</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}, </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>搭配使用上面几种中间件，你的机器人便拥有了无限可能。在 koishi-plugin-common 库中，就有着一个官方实现的复读功能，它远比上面的示例所显示的更加强大。如果想深入了解中间件机制，可以去研究一下这个功能的 <a href="https://github.com/koishijs/koishi/blob/master/packages/plugin-common/src/handler.ts" target="_blank" rel="noopener noreferrer">源代码<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>。</p><h2 id="使用会话" tabindex="-1"><a class="header-anchor" href="#使用会话" aria-hidden="true">#</a> 使用会话</h2><h3 id="延时发送" tabindex="-1"><a class="header-anchor" href="#延时发送" aria-hidden="true">#</a> 延时发送</h3><p>如果你需要连续发送多条消息，那么在各条消息之间留下一定的时间间隔是很重要的：一方面它可以防止消息刷屏和消息错位（后发的条消息呈现在先发的消息前面），提高了阅读体验；另一方面它能够有效降低机器人发送消息的频率，防止被平台误封。这个时候，<code>session.sendQueued()</code> 可以解决你的问题。</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 发送两条消息，中间间隔一段时间，这个时间由系统计算决定</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">sendQueued</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;message1&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">sendQueued</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;message2&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 清空等待队列</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">cancelQueued</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>你也可以在发送时手动定义等待的时长：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 如果消息队列非空，在前一条消息发送完成后 1s 发送本消息</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">sendQueued</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;message3&#39;</span><span style="color:#F8F8F2;">, Time.second)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 清空等待队列，并设定下一条消息发送距离现在至少 0.5s</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">cancelQueued</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0.5</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> Time.second)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>事实上，对于不同的消息长度，系统等待的时间也是不一样的，你可以通过配置项修改这个行为：</p><div class="panel-view code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><span class="title-text">koishi.config.js</span><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">module</span><span style="color:#F8F8F2;">.</span><span style="color:#66D9EF;font-style:italic;">exports</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  delay: {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 消息里每有一个字符就等待 0.02s</span></span>
<span class="line"><span style="color:#F8F8F2;">    character: </span><span style="color:#AE81FF;">0.02</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> Time.second,</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 每条消息至少等待 0.5s</span></span>
<span class="line"><span style="color:#F8F8F2;">    message: </span><span style="color:#AE81FF;">0.5</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> Time.second,</span></span>
<span class="line"><span style="color:#F8F8F2;">  },</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>这样一来，一段长度为 60 个字符的消息发送后，下一条消息发送前就需要等待 1.2 秒了。</p><h3 id="等待用户输入" tabindex="-1"><a class="header-anchor" href="#等待用户输入" aria-hidden="true">#</a> 等待用户输入</h3><p>当你需要进行一些交互式操作时，可以使用 <code>session.prompt()</code>：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;请输入用户名：&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> name </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">prompt</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">!</span><span style="color:#F8F8F2;">name) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;输入超时。&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 执行后续操作</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> ctx.database.</span><span style="color:#A6E22E;">setUser</span><span style="color:#F8F8F2;">(session.platform, session.userId, { name })</span></span>
<span class="line"><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">`</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">name</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">，请多指教！`</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>你可以给这个方法传入一个 <code>timeout</code> 参数，或使用 <code>delay.prompt</code> 配置项，来作为等待的时间。</p><h3 id="调用底层接口" tabindex="-1"><a class="header-anchor" href="#调用底层接口" aria-hidden="true">#</a> 调用底层接口</h3><p>当然，你所能做的并不只有在当前频道内发送信息那么简单。我们还提供了 Bot 类，允许你进行更多机器人操作。你可以像这样调用它：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 向特定频道发送消息</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.bot.</span><span style="color:#A6E22E;">sendMessage</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">123456789</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;Hello world&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 获取特定群的成员列表</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> members </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.bot.</span><span style="color:#A6E22E;">getGroupMemberList</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">987654321</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>你可以在 <a href="/v3/api/bot.html" class=""><strong>机器人</strong></a> 一章中看到完整的 API 列表。</p><h3 id="发送广播消息" tabindex="-1"><a class="header-anchor" href="#发送广播消息" aria-hidden="true">#</a> 发送广播消息</h3><p>有的时候你可能希望向多个频道同时发送消息，我们也专门设计了相关的接口。</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 使用当前机器人账户向多个频道发送消息</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> session.bot.</span><span style="color:#A6E22E;">broadcast</span><span style="color:#F8F8F2;">([</span><span style="color:#E6DB74;">&#39;123456&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;456789&#39;</span><span style="color:#F8F8F2;">], content)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 如果你有多个账号，请使用 ctx.broadcast，并在频道编号前加上平台名称</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> ctx.</span><span style="color:#A6E22E;">broadcast</span><span style="color:#F8F8F2;">([</span><span style="color:#E6DB74;">&#39;onebot:123456&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;discord:456789&#39;</span><span style="color:#F8F8F2;">], content)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 或者直接将消息发给所有频道</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> ctx.</span><span style="color:#A6E22E;">broadcast</span><span style="color:#F8F8F2;">(content)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>如果你希望广播消息的发送也有时间间隔的话，可以使用 <code>delay.broadcast</code> 配置项。</p><h2 id="处理消息文本" tabindex="-1"><a class="header-anchor" href="#处理消息文本" aria-hidden="true">#</a> 处理消息文本</h2><h3 id="使用消息段" tabindex="-1"><a class="header-anchor" href="#使用消息段" aria-hidden="true">#</a> 使用消息段</h3><p>当然，一个聊天平台所能发送或接收的内容往往不只有纯文本——请放心，无论是 @其他人、发送表情、上传文件还是更加复杂的卡片消息都是 Koishi 所能处理的范围。</p><p><code>segment()</code> 函数传入两个参数，第一个参数是消息段的类型，第二个参数是一个对象，表示这个消息段的属性。如果希望在你的消息中 @某某用户，或发送一张图片，你可以使用下面的写法：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// @某某用户 我在叫你哟！</span></span>
<span class="line"><span style="color:#F8F8F2;">session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">segment</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;at&#39;</span><span style="color:#F8F8F2;">, { id: userId }) </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;我在叫你哟！&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// 你发送了一张 Koishi 图标</span></span>
<span class="line"><span style="color:#F8F8F2;">session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">segment</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;image&#39;</span><span style="color:#F8F8F2;">, { url: </span><span style="color:#E6DB74;">&#39;https://koishi.js.org/koishi.png&#39;</span><span style="color:#F8F8F2;"> }))</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p><strong>前缀消息段</strong>表达了你发送的消息具有某些特殊语义。当你要发送匿名消息，或者引用其他消息的内容，你同样只需要在消息的开头加上一个消息段即可：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">segment</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;anonymous&#39;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;这是一条匿名消息。&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">session.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">segment</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;quote&#39;</span><span style="color:#F8F8F2;">, { id: messageId }) </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;这是一条回复消息。&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>为了方便起见，在实际应用时，你可以使用 <code>s()</code> 代替 <code>segment()</code>。</p><h3 id="使用模板" tabindex="-1"><a class="header-anchor" href="#使用模板" aria-hidden="true">#</a> 使用模板</h3><p>Koishi 自身就提供了丰富的生态，但如果你觉得某些功能输出的内容缺乏个性化，有没有办法修改它们的行为呢？这时候就可以使用<strong>模板</strong>来解决。</p><p>使用 <code>template.set()</code> 定义一个模板，并使用 <code>template()</code> 获取一个模板的值：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">template.</span><span style="color:#A6E22E;">set</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;foo&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;foo{0}ooo&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">template</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;foo&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;bar&#39;</span><span style="color:#F8F8F2;">) </span><span style="color:#88846F;">// &#39;foobarooo&#39;</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><p>又因为官方的多数输出行为都可以使用模板控制，你便可以通过 <code>template.set()</code> 覆盖这些行为了。下面举一个例子（假设 echo 是一条有时间间隔限制的指令）：</p><div class="panel-view mini code" style=""><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><!----><!----></div></div><div class="content"><!--[--><!--[--><!--[--><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">template.</span><span style="color:#A6E22E;">set</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;internal.too-frequent&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;调用太频繁了亲~&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span></code></pre><!--]--><!--]--><!--]--></div></div><div class="panel-view"><div class="controls"><div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div><div class="title"><span class="title-text">聊天记录</span><!----></div></div><div class="content"><!--[--><!--[--><!--[--><div class="chat-message"><div class="avatar" style="background-color:#cc0066;">A</div><div class="nickname">Alice</div><div class="message-box"><!--[-->echo foo<!--]--></div></div><div class="chat-message" avatar="/koishi.png"><img class="avatar" src="/v3/koishi.png"><div class="nickname">Koishi</div><div class="message-box"><!--[-->foo<!--]--></div></div><div class="chat-message"><div class="avatar" style="background-color:#cc0066;">A</div><div class="nickname">Alice</div><div class="message-box"><!--[-->echo foo<!--]--></div></div><div class="chat-message" avatar="/koishi.png"><img class="avatar" src="/v3/koishi.png"><div class="nickname">Koishi</div><div class="message-box"><!--[-->调用太频繁了亲~<!--]--></div></div><!--]--><!--]--><!--]--></div></div><p>为了方便起见，在实际应用时，你可以使用 <code>t()</code> 代替 <code>template()</code>。</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/koishijs/v3/edit/docs/guide/message.md" rel="noopener noreferrer" target="_blank" aria-label="帮助我们改善此页面"><!--[--><!--]--> 帮助我们改善此页面 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">11/16/2021, 7:34:27 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: shigma10826@gmail.com">Shigma</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/v3/guide/context.html" class="nav-link" aria-label="插件与上下文"><!--[--><!--]--> 插件与上下文 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/v3/assets/app.9e111ae1.js" defer></script>
  </body>
</html>
